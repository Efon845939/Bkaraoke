/**
 * @fileoverview Firestore Security Rules for Song Request App
 *
 * Core Philosophy:
 * This ruleset enforces a role-based access control model with students and admins.
 * Students can manage their own profiles and submit song requests. Admins have broad access
 * for managing song requests and viewing audit logs. Data validation is minimized for rapid prototyping.
 *
 * Data Structure:
 * - /students/{studentId}: Stores student profiles, accessible only by the student themselves (owner) or admins.
 * - /song_requests/{songRequestId}: Stores all song requests. Accessible for reading by all authenticated users,
 *   but creation is restricted to students. Updates and Deletes are only allowed by admins.
 * - /audit_logs/{logId}: Stores audit logs, only accessible to admins.
 *
 * Key Security Decisions:
 * - Students can only read and update their own profile.
 * - Admins can read and write all students profiles.
 * - Song requests are publicly readable to authenticated users, but only students can create them. Only admins can update or delete requests.
 * - Audit logs are only readable and writeable by admins.
 * - Listing of users is explicitly denied to prevent information disclosure.
 *
 * Denormalization for Authorization:
 * - The `SongRequest` entity includes the `studentId` field, enabling rules to easily check the submitter of a song request.
 *
 * Structural Segregation:
 * - There are no draft/published content types, so structural segregation is not required.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Rules for student profiles. Students can read/write their own profile. Admins have full access.
     * @path /students/{studentId}
     * @allow (read, update) User abc can read or update their own profile: request.auth.uid == 'abc'
     * @allow (create) User abc can create their profile: request.auth.uid == 'abc'
     * @allow (read, write) Admin user can read or write any student profile
     * @deny (read, write) User abc can't read/write user bcd profile: request.auth.uid != 'abc'
     * @principle Enforces document ownership and role-based access control.
     */
    match /students/{studentId} {
      allow get: if isSignedIn() && (isOwner(studentId) || isAdmin());
      allow list: if false; // Explicitly prevent listing of users.
      allow create: if isSignedIn() && isOwner(studentId);
      allow update: if isSignedIn() && (isOwner(studentId) || isAdmin()) && isExistingDocument();
      allow delete: if false;
    }

    /**
     * @description Rules for song requests. All authenticated users can read requests. Only students can create requests. Admins can update and delete.
     * @path /song_requests/{songRequestId}
     * @allow (read) Any logged in user can read any song request.
     * @allow (create) User abc can create a song request if studentId matches their UID: request.auth.uid == 'abc'
     * @allow (update, delete) Admin user can update or delete any song request
     * @deny (create) User abc can't create a song request with a mismatched studentId: request.auth.uid != request.resource.data.studentId
     * @deny (update, delete) Non-admin user cannot update or delete a song request.
     * @principle Allows public read access while restricting write access to owners and admins.
     */
    match /song_requests/{songRequestId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn() && isStudent();
      allow update: if isSignedIn() && isAdmin() && isExistingDocument();
      allow delete: if isSignedIn() && isAdmin() && isExistingDocument();
    }

    /**
     * @description Rules for audit logs. Only admins can read and write logs.
     * @path /audit_logs/{logId}
     * @allow (read, write) Admin user can read or write audit logs.
     * @deny (read, write) Non-admin user cannot access audit logs.
     * @principle Restricts access to audit logs to administrative users.
     */
    match /audit_logs/{logId} {
      allow get: if isSignedIn() && isAdmin();
      allow list: if isSignedIn() && isAdmin();
      allow create: if isSignedIn() && isAdmin();
      allow update: if isSignedIn() && isAdmin() && isExistingDocument();
      allow delete: if isSignedIn() && isAdmin() && isExistingDocument();
    }

    // --- Helper functions ---

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function isAdmin() {
      return get(/databases/$(database)/documents/students/$(request.auth.uid)).data.role == 'admin';
    }

    function isStudent() {
      return get(/databases/$(database)/documents/students/$(request.auth.uid)).data.role == 'student';
    }

    function isExistingDocument() {
        return resource != null;
    }
  }
}