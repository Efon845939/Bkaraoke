rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isAdmin() {
      return isSignedIn() && get(/databases/$(database)/documents/students/$(request.auth.uid)).data.role == 'admin';
    }

    function isExistingOwner(userId) {
      return isOwner(userId); // Removed resource != null condition as it's not needed in the isOwner context.
    }

    /**
     * @description Manages student profiles, allowing students to create their own profiles and admins to manage all profiles.
     * @path /students/{studentId}
     * @allow (create) User with UID 'user123' can create a profile if studentId == 'user123'.
     * @allow (update) Admin can update any student profile.
     * @deny (create) User with UID 'user123' cannot create a profile if studentId != 'user123'.
     * @deny (delete) Non-admin users cannot delete student profiles.
     * @principle Enforces user-ownership for profile creation and admin control for management.
     */
    match /students/{studentId} {
      allow get: if isSignedIn();
      allow list: if false;
      allow create: if isOwner(studentId);
      allow update, delete: if isAdmin();
    }

    /**
     * @description Manages song requests, allowing creation by students and management by admins.
     * @path /song_requests/{songRequestId}
     * @allow (create) User with UID 'user123' can create a song request with studentId == 'user123'.
     * @allow (update) Admin can update any song request.
     * @deny (create) User with UID 'user123' cannot create a song request if studentId != 'user123'.
     * @deny (delete) Non-admin users cannot delete song requests.
     * @principle Enforces user-ownership for song request creation and admin control for management.
     */
    match /song_requests/{songRequestId} {
      allow get, list: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.studentId == request.auth.uid;
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

      /**
       * @description Stores a chronological log of all significant actions taken in the application.
       * @path /audit_logs/{logId}
       * @allow (get, list) Admins can get and list logs.
       * @allow (create) Only the application backend can create logs.
       * @deny (update, delete) No one can update or delete logs (immutable).
       * @principle Restricts audit log access to admins and prevents tampering.
       */
    match /audit_logs/{logId} {
        allow get, list: if isAdmin();
        allow create: if true; // Simulate backend access. In production, this might be authenticated differently.
        allow update, delete: if false;
    }
  }
}