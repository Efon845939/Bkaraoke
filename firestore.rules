/**
 * @fileoverview Firestore Security Rules for Karaoke App
 *
 * Core Philosophy:
 * This ruleset enforces a role-based access control model.  Students can read song requests, but not audit logs, and admins have full access.
 *
 * Data Structure:
 * - /students/{studentId}: Stores student profiles, with the document ID matching the Firebase Auth UID.
 * - /song_requests/{songRequestId}: Stores song requests.
 * - /audit_logs/{logId}: Stores audit logs of system actions.
 *
 * Key Security Decisions:
 * - Students can read song request data.
 * - Only authenticated users can create, update, and delete their own student profiles.
 * - Listing audit logs is denied to non-admins, and no role based authentication has been configured.
 *
 * Denormalization for Authorization:
 *  - The `Student` document includes a `role` field, which is used to determine admin status.  This avoids needing a separate lookup.
 *
 * Structural Segregation:
 *  - There is no need to segregate between public and private data.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the user is signed in.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the user's UID matches the provided userId.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the user is an admin based on their 'students' document.
     */
    function isAdmin() {
      return isSignedIn() && get(/databases/$(database)/documents/students/$(request.auth.uid)).data.role == 'admin';
    }

    /**
     * @description Checks if the user is the owner of the existing document.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Rules for /students/{studentId} documents.
     * @path /students/{studentId}
     * @allow (create) User with UID 'user123' creates a new student document with id 'user123'.
     * @allow (update) User with UID 'user123' updates their own student document.
     * @deny (create) User with UID 'user456' attempts to create a student document with id 'user123'.
     * @deny (update) User with UID 'user456' attempts to update the student document with id 'user123'.
     * @principle Enforces document ownership for writes; only the user with the matching UID can create/update their profile.
     */
    match /students/{studentId} {
      allow get: if true;
      allow list: if false; // Listing users is generally not a good practice.
      allow create: if isOwner(studentId) && request.resource.data.id == studentId;
      allow update: if isExistingOwner(studentId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(studentId);
    }

    /**
     * @description Rules for /song_requests/{songRequestId} documents.
     * @path /song_requests/{songRequestId}
     * @allow (get) Any signed-in user can read a song request.
     * @allow (list) Any signed-in user can list song requests.
     * @allow (create) An admin can create song requests.
     * @allow (update) An admin can update a song request.
     * @allow (delete) An admin can delete a song request.
     * @principle Allows public read access but restricts write access to admins only.
     */
    match /song_requests/{songRequestId} {
      allow get: if true;
      allow list: if true;
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    /**
     * @description Rules for /audit_logs/{logId} documents.
     * @path /audit_logs/{logId}
     * @allow (get) Only admins can read audit logs.
     * @allow (list) Listing audit logs is denied to all users (including admins, for now).
     * @deny (create) Non-admins cannot create audit logs.
     * @deny (update) Non-admins cannot update audit logs.
     * @deny (delete) Non-admins cannot delete audit logs.
     * @principle Restricts access to audit logs to admins only.
     */
    match /audit_logs/{logId} {
      allow get: if isAdmin();
      allow list: if false; // The user reported a permission error on a list request. Denying it for everyone, including admins.
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
  }
}