rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * Helper functions
     */
    function isSignedIn() {
      return request.auth != null;
    }

    function hasEmail() {
      return isSignedIn() && request.auth.token.email != null;
    }

    function isOwner() {
      return hasEmail() && request.auth.token.email.matches(".*@karaoke\\.owner\\.app$");
    }

    function isAdmin() {
      return hasEmail() && request.auth.token.email.matches(".*@karaoke\\.admin\\.app$");
    }

    function isParticipant() {
      return hasEmail() && request.auth.token.email.matches(".*@karaoke\\.app$");
    }

    function isOwnerOfParticipant(participantId) {
        return isSignedIn() && request.auth.uid == participantId;
    }

    // Participant profile lookup — used to check the 'disabled' status
    function getParticipantDoc(uid) {
      return get(/databases/$(database)/documents/students/$(uid));
    }

    function notDisabled(uid) {
      return !getParticipantDoc(uid).data.disabled;
    }

    /**
     * @description Rules for participant profiles (students collection).
     * @path /students/{participantId}
     * @allow (read) Owner, admin or the participant themselves, if not disabled.
     * @allow (create) Any signed-in user.
     * @allow (update) Owner or the participant themselves, if not disabled.
     * @deny (delete) No one can delete a participant profile.
     * @principle Enforces role-based access control and disables account deletion.
     */
    match /students/{participantId} {
      allow get:    if isOwner() || isAdmin() || (isSignedIn() && request.auth.uid == participantId);
      allow list:   if isOwner() || isAdmin();
      allow create: if isSignedIn() && request.auth.uid == participantId;
      allow update: if isOwner() || (isSignedIn() && request.auth.uid == participantId);
      allow delete: if false;  // ← ACCOUNT DELETION COMPLETELY DISABLED
    }

    /**
     * @description Rules for song requests.
     * @path /song_requests/{songRequestId}
     * @allow (read) Owner, admin, or the participant who made the request (if not disabled).
     * @allow (create) Any signed-in user for their own requests (if not disabled).
     * @allow (update) Owner or the participant who made the request.
     * @deny (delete) No one can delete a song request.
     * @principle Enforces role-based access control and disables request deletion.
     */
    match /song_requests/{songRequestId} {
      allow get:    if isOwner() || isAdmin() || (isSignedIn() && request.auth.uid == resource.data.participantId);
      allow list:   if isOwner() || isAdmin();
      allow create: if isSignedIn() && request.auth.uid == request.resource.data.participantId;
      allow update: if isOwner() || (isSignedIn() && request.auth.uid == resource.data.participantId);
      allow delete: if false;  // ← REQUEST DELETION ALSO DISABLED
    }

    /**
     * @description Rules for audit logs.
     * @path /audit_logs/{logId}
     * @allow (read) Only owners can read audit logs.
     * @allow (create) Any signed-in user can create audit logs.
     * @deny (update, delete) No one can update or delete audit logs.
     * @principle Restricts read access to audit logs and prevents modification.
     */
    match /audit_logs/{logId} {
      allow get:    if isOwner() || isAdmin();
      allow list:   if isOwner() || isAdmin();
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Catches all other documents and denies access.
     * @path /{document=**}
     * @deny (read, write) All read and write operations are denied by default.
     * @principle Enforces a default-deny security posture.
     */
    match /{document=**} {
      allow get: if false;
      allow list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }
  }
}