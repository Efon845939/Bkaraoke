/**
 * @fileoverview Firestore Security Rules for Karaoke Owner App
 *
 * Core Philosophy:
 * This ruleset enforces a role-based access control model for students and admins.
 * Students can read SongRequests, but only admins can create, update, and delete them.
 * Students have full ownership of their profiles, while AuditLogs are write-only for admins.
 *
 * Data Structure:
 * - /students/{studentId}: Stores user profiles, where studentId matches the Firebase Auth UID.
 * - /song_requests/{songRequestId}: Stores all song requests.
 * - /audit_logs/{logId}: Stores audit logs.
 *
 * Key Security Decisions:
 * - Students can list SongRequests
 * - AuditLogs are append-only, and not readable by anyone from the client.
 * - The ruleset does not validate the specific data types or presence of all fields during write operations.
 *
 * Denormalization for Authorization:
 * - SongRequests include the studentId to easily check the submitter.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the user is signed in.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the user's ID matches the requested user ID.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the user is an admin.
     * @details This function would need to reference a source of truth for admin status (e.g., a document in /admins/{userId}).
     *          Since no such structure is defined, this function defaults to always false and must be updated to function correctly.
     */
    function isAdmin() {
      // TODO: Implement admin role verification (e.g., by checking a /admins/{userId} document).
      return false;
    }

    /**
     * @description Checks if the document exists and the user is the owner.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Rules for /students/{studentId} documents.
     * @path /students/{studentId}
     * @allow (create) User with UID 'user123' can create a profile with id: 'user123', name: 'Test User', role: 'student'.
     * @deny (create) User with UID 'user456' cannot create a profile with id: 'user123'.
     * @allow (get, list) User with UID 'user123' can read their profile.
     * @deny (get, list) User with UID 'user456' cannot read user 'user123' profile.
     * @allow (update) User with UID 'user123' can update their profile name.
     * @deny (update) User with UID 'user456' cannot update user 'user123' profile.
     * @allow (delete) User with UID 'user123' can delete their profile.
     * @deny (delete) User with UID 'user456' cannot delete user 'user123' profile.
     * @principle Enforces document ownership for writes.
     */
    match /students/{studentId} {
      allow get: if isOwner(studentId);
      allow list: if false; // Prevent listing of all user documents.
      allow create: if isOwner(studentId) && request.resource.data.id == studentId;
      allow update: if isExistingOwner(studentId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(studentId);
    }

    /**
     * @description Rules for /song_requests/{songRequestId} documents.
     * @path /song_requests/{songRequestId}
     * @allow (get, list) Any signed-in user can view all song requests.
     * @allow (create) An admin can create a song request.
     * @deny (create) A student cannot create a song request.
     * @allow (update) An admin can update a song request.
     * @deny (update) A student cannot update a song request.
     * @allow (delete) An admin can delete a song request.
     * @deny (delete) A student cannot delete a song request.
     * @principle Restricts write access to admins only.
     */
    match /song_requests/{songRequestId} {
      allow get: if true;
      allow list: if true;
      allow create: if isAdmin();
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }

    /**
     * @description Rules for /audit_logs/{logId} documents.
     * @path /audit_logs/{logId}
     * @allow (create) Only admins can create audit logs.
     * @deny (get, list, update, delete) No one can get, list, update, or delete audit logs via the client.
     * @principle Append-only collection for audit trails, writeable only by admins.
     */
    match /audit_logs/{logId} {
      allow get: if false;
      allow list: if false;
      allow create: if isAdmin();
      allow update: if false;
      allow delete: if false;
    }
  }
}