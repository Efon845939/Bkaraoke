rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Auth helpers ---
    function signedIn() { return request.auth != null; }
    function hasEmail() { return signedIn() && request.auth.token.email != null; }

    // --- Role checks (domain bazlı) ---
    function isOwner()        { return hasEmail() && request.auth.token.email.matches(".*@karaoke\\.owner\\.app$"); }
    function isAdmin()        { return hasEmail() && request.auth.token.email.matches(".*@karaoke\\.admin\\.app$"); }
    function isParticipant()  { return hasEmail() && request.auth.token.email.matches(".*@karaoke\\.app$"); }

    // --- Ownership (katılımcının kendi verisi) ---
    function isSelf(doc) {
      return signedIn() && doc.participantId != null && doc.participantId == request.auth.uid;
    }

    // --- KATILIMCI PROFİLLERİ (/students) ---
    // Owner/Admin: tüm profilleri okur; Katılımcı: sadece kendi profiline tam yetki (read/update/delete).
    match /students/{participantId} {
      allow read:   if isOwner() || isAdmin() || (signedIn() && request.auth.uid == participantId);
      allow create: if signedIn();
      allow update: if isOwner() || (signedIn() && request.auth.uid == participantId);
      allow delete: if isOwner() || (signedIn() && request.auth.uid == participantId);
    }

    // --- ŞARKI İSTEKLERİ (/song_requests) ---
    // Owner/Admin: tümünü görür/işler; Katılımcı: sadece kendi isteklerini görür/işler/siler (participantId zorunlu).
    match /song_requests/{id} {
      allow read:   if isOwner() || isAdmin() || isSelf(resource.data);
      allow create: if signedIn();
      allow update: if isOwner() || isSelf(resource.data);
      allow delete: if isOwner() || isSelf(resource.data);
    }

    // --- Denetim Günlükleri (/audit_logs) ---
    // Sadece Owner okur; herkes log oluşturabilir.
    match /audit_logs/{id} {
      allow read:   if isOwner();
      allow create: if signedIn();
      allow update, delete: if false;
    }

    // Default deny
    match /{document=**} { allow read, write: if false; }
  }
}
