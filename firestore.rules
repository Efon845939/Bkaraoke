/**
 * @fileoverview Firestore Security Rules for Karaoke Owner App.
 *
 * Core Philosophy:
 * This ruleset enforces a role-based access control model for students and admins.
 * Students can read their own profiles, but not list all students. Admins have no specific role-based special access in this prototype.
 * Song requests are publicly readable, but creation, updates, and deletion are restricted to authenticated users.
 * Audit logs are write-only for server-side functions or admin clients; regular users cannot read or write them.
 *
 * Data Structure:
 * - /students/{studentId}: Stores student profiles. The 'studentId' MUST match the Firebase Auth UID.
 * - /song_requests/{songRequestId}: Stores all song requests.
 * - /audit_logs/{logId}: Stores audit logs.
 *
 * Key Security Decisions:
 * - Listing all students is denied to prevent information disclosure.
 * - Read-only collections: None in this version, but audit logs are effectively write-only.
 * - Default security posture: Strict access control.
 *
 * Denormalization for Authorization:
 * - Song requests contain the `studentId` to quickly verify the submitter.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Rule for securing the /students collection.
     * @path /databases/{database}/documents/students/{studentId}
     * @allow (create) User with UID 'user_abc' can create their profile at /students/user_abc.
     * @deny (create) User with UID 'user_abc' cannot create a profile at /students/user_xyz.
     * @allow (get) User with UID 'user_abc' can read their profile at /students/user_abc.
     * @deny (get) User with UID 'user_abc' cannot read the profile at /students/user_xyz.
     * @deny (update) User with UID 'user_abc' cannot update the profile at /students/user_xyz.
     * @deny (delete) User with UID 'user_abc' cannot delete the profile at /students/user_xyz.
     * @deny (list) Any user cannot list all students.
     * @principle Enforces user ownership for student profiles.
     */
    match /students/{studentId} {
      // Helper function to check if the authenticated user is the owner of the student document.
      function isOwner(studentId) {
        return request.auth != null && request.auth.uid == studentId;
      }

      // Helper function to check if the authenticated user is the owner of an existing student document.
      function isExistingOwner(studentId) {
        return isOwner(studentId) && resource != null;
      }

      allow get: if isOwner(studentId);
      allow list: if false;

      allow create: if isOwner(studentId) && request.resource.data.id == studentId;
      allow update: if isExistingOwner(studentId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(studentId);
    }

    /**
     * @description Rule for securing the /song_requests collection.
     * @path /databases/{database}/documents/song_requests/{songRequestId}
     * @allow (get) Any user can read any song request.
     * @allow (list) Any user can list all song requests.
     * @allow (create) User with UID 'user_abc' can create a song request. The 'studentId' field must match the user's UID.
     * @deny (create) User with UID 'user_abc' cannot create a song request with a mismatched 'studentId'.
     * @allow (update) User with UID 'user_abc' can update a song request if they are the original submitter.
     * @deny (update) User with UID 'user_abc' cannot update a song request submitted by another user.
     * @allow (delete) User with UID 'user_abc' can delete a song request if they are the original submitter.
     * @deny (delete) User with UID 'user_abc' cannot delete a song request submitted by another user.
     * @principle Allows public read access but enforces ownership for write operations.
     */
    match /song_requests/{songRequestId} {
      // Helper function to check if the authenticated user is the owner of the song request.
      function isSongRequestOwner(studentId) {
        return request.auth != null && request.auth.uid == studentId;
      }

       // Helper function to check if the authenticated user is the owner of an existing song request.
      function isExistingSongRequestOwner(studentId) {
        return isSongRequestOwner(studentId) && resource != null;
      }
    
      allow get, list: if true;
      allow create: if request.auth != null && request.resource.data.studentId == request.auth.uid;
      allow update: if request.auth != null && isExistingSongRequestOwner(resource.data.studentId);
      allow delete: if request.auth != null && isExistingSongRequestOwner(resource.data.studentId);
    }

     /**
      * @description Rule for securing the /audit_logs collection.
      * @path /databases/{database}/documents/audit_logs/{logId}
      * @deny (get) No one can read audit logs.
      * @deny (list) No one can list audit logs.
      * @allow (create) Any authenticated user can create an audit log (e.g., server-side).
      * @deny (update) No one can update audit logs.
      * @deny (delete) No one can delete audit logs.
      * @principle Allows only creation of audit logs, effectively making it a write-only collection.
      */
    match /audit_logs/{logId} {
      allow get, list: if false;
      allow create: if request.auth != null;
      allow update, delete: if false;
    }
  }
}