/**
 * @fileoverview Firestore Security Rules for the Karaoke Request App.
 *
 * Core Philosophy:
 * This ruleset enforces a user-ownership model for student profiles,
 * allowing each student to manage their own profile data. Song requests
 * are stored in a shared collection and are publicly readable, but can only be
 * created with a valid student ID and modified/deleted by an admin (not implemented in these rules).
 *
 * Data Structure:
 * - /students/{studentId}: Stores individual student profiles, with the `studentId` matching the Firebase Auth UID.
 * - /song_requests/{songRequestId}: Stores all song requests.
 *
 * Key Security Decisions:
 * - Students can only read and write their own profile data.
 * - Song requests are publicly readable to allow for display in the app.
 * - No validation on the exact shape of data to allow for rapid prototyping.
 * - Admin roles are not implemented.
 *
 * Denormalization for Authorization:
 * - The `SongRequest` entity denormalizes the student's name (`studentName`) for display purposes.
 *   Authorization is still based on the `studentId` field to ensure the request belongs to the authenticated user.
 *
 * Structural Segregation:
 * - The application uses separate collections for student profiles (private) and song requests (public read),
 *   optimizing for different access patterns and security requirements.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows students to manage their own profile data.
     * @path /students/{studentId}
     * @allow (create) - A student can create their own profile if the studentId matches their auth UID.
     * @allow (get, list, update, delete) - A student can read, update, and delete their profile if the studentId matches their auth UID.
     * @deny - A student cannot create, read, update, or delete another student's profile.
     * @principle Enforces document ownership for student profiles.
     */
    match /students/{studentId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return isSignedIn() && request.auth.uid == userId;
      }

      allow get: if isOwner(studentId);
      allow list: if isOwner(studentId);
      allow create: if isOwner(studentId) && request.resource.data.id == studentId;
      allow update: if isOwner(studentId) && resource.data.id == studentId;
      allow delete: if isOwner(studentId) && resource != null; //Ensures document exists before deleting
    }

    /**
     * @description Allows anyone to read song requests, but only authenticated users can create them with their student ID.
     * @path /song_requests/{songRequestId}
     * @allow (get, list) - Anyone can read song requests.
     * @allow (create) - An authenticated user can create a song request with their student ID.
     * @deny (update, delete) - Only admins can update or delete song requests (not implemented).
     * @principle Allows public read access for song requests with authenticated creation and admin-only modification.
     */
    match /song_requests/{songRequestId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.studentId == request.auth.uid;
      allow update: if false; // TODO: Add admin role check
      allow delete: if false; // TODO: Add admin role check
    }
  }
}