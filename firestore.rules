rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to student profiles. Students can create and manage their own profiles.
     * @path /databases/{database}/documents/students/{studentId}
     * @allow (create) - Authenticated user with UID matching {studentId} can create their profile.
     * @allow (update) - Authenticated user with UID matching {studentId} can update their profile.
     * @allow (get) - Authenticated user can get any profile.
     * @allow (list) - Listing all students is disallowed.
     * @deny (delete) - No one can delete a student profile.
     * @principle Enforces document ownership for student profiles.
     */
    match /students/{studentId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(studentId) {
        return request.auth.uid == studentId;
      }

      allow get: if isSignedIn();
      allow list: if false;
      allow create: if isSignedIn() && isOwner(studentId);
      allow update: if isSignedIn() && isOwner(studentId);
      allow delete: if false;
    }

    /**
     * @description Controls access to song requests. Authenticated users can create song requests.
     * @path /databases/{database}/documents/song_requests/{songRequestId}
     * @allow (create) - Authenticated user can create a song request. Requires studentId to match the authenticated user ID.
     * @allow (update) - Authenticated user can update a song request if they are the owner.
     * @allow (get) - Any user can read a song request.
     * @allow (list) - Any user can list song requests.
     * @deny (delete) - Only the owner can delete a song request.
     * @principle Enforces authentication for creation and ownership for updates.
     */
    match /song_requests/{songRequestId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(studentId) {
          return request.auth.uid == studentId;
      }

      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.studentId == request.auth.uid;
      allow update: if isSignedIn() && request.resource.data.studentId == request.auth.uid;
      allow delete: if isSignedIn() && request.resource.data.studentId == request.auth.uid;
    }

    /**
     * @description Controls access to audit logs.  Only admins can read audit logs.
     * @path /databases/{database}/documents/audit_logs/{logId}
     * @allow (get) - Admins can read audit logs.
     * @allow (list) - Admins can list audit logs.
     * @deny (create) - No one can create audit logs through client side.
     * @deny (update) - No one can update audit logs.
     * @deny (delete) - No one can delete audit logs.
     * @principle Restricts audit log access to authorized personnel.
     */
    match /audit_logs/{logId} {
      function isSignedIn() {
        return request.auth != null;
      }

      // TODO: Add a check for admin role. This requires storing roles in a way accessible to the rules.
      function isAdmin() {
        return false; // Placeholder. Replace with actual admin role check.
      }
      allow get, list: if isSignedIn() && isAdmin(); // TODO: Only allow admins to get, list
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }
  }
}