/**
 * @file Firestore Security Rules
 * @core-philosophy This ruleset enforces a role-based access control model with additional owner-based restrictions.
 *   The roles are determined by the domain of the user's email address.
 * @data-structure
 *   - /students/{studentId}: Stores student and admin profiles. The 'studentId' MUST match the authenticated user's UID.
 *   - /song_requests/{songRequestId}: Stores song requests. Each request contains a 'studentId' linking it to the user who made the request.
 *   - /audit_logs/{logId}: Stores audit logs, accessible only to owners.
 * @key-security-decisions
 *   - Role-based access control: Owners and admins have broad access, while students have more restricted access.
 *   - Owner-based access control: Students can only read and update their own profiles and song requests.
 *   - Data denormalization: The 'song_requests' collection denormalizes 'studentId' to efficiently check ownership.
 *   - List operations are allowed only for owners on audit logs, otherwise forbidden.
 *   - Regex used for emails.
 */
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() { return request.auth != null; }
    function hasEmail()   { return isSignedIn() && request.auth.token.email != null; }

    // Case-insensitive domain kontrolü (RE2)
    function isOwner() {
      return hasEmail() && request.auth.token.email.matches('(?i)[^@]+@karaoke\\.owner\\.app$');
    }
    function isAdmin() {
      return hasEmail() && request.auth.token.email.matches('(?i)[^@]+@karaoke\\.admin\\.app$');
    }
    function isStudent() {
      return hasEmail() && request.auth.token.email.matches('(?i)[^@]+@karaoke\\.app$');
    }

    function isOwnerOfDoc(doc) {
      return isSignedIn() && doc.studentId == request.auth.uid;
    }

    /**
     * @description Manages student profiles.
     * @path /students/{studentId}
     * @allow (read) User with ID 'studentId' reads their own profile.
     * @allow (read) Owner reads any student profile.
     * @deny (read) User tries to read another user's profile.
     * @allow (create) Signed-in user can create their profile.
     * @allow (update) User with ID 'studentId' updates their own profile.
     * @allow (update) Owner updates any student profile.
     * @deny (update) User tries to update another user's profile.
     * @deny (delete) No one can delete student profiles.
     * @principle Enforces role-based access control and owner-based access control.
     */
    match /students/{studentId} {
      // Owner veya Admin tümünü okuyabilir. Kullanıcı kendi belgesini okuyabilir/güncelleyebilir.
      allow get:   if isOwner() || isAdmin() || (isSignedIn() && request.auth.uid == studentId);
      allow list: if isOwner() || isAdmin();
      allow create: if isSignedIn() && request.auth.uid == studentId;
      allow update: if isOwner() || isAdmin() || (isSignedIn() && request.auth.uid == studentId);
      allow delete: if false;
    }

    /**
     * @description Manages song requests.
     * @path /song_requests/{songRequestId}
     * @allow (read) Owner/Admin reads all song requests.
     * @allow (read) Student can read their own song request.
     * @deny (read) Student reads other song requests.
     * @allow (create) Any signed-in user creates a song request.
     * @allow (update) Owner/Admin updates all song requests.
     * @allow (update) Student can update their own song request.
     * @deny (update) Student updates other song requests.
     * @allow (delete) Owner/Admin deletes all song requests.
     * @allow (delete) Student deletes their own song request.
     * @deny (delete) Student deletes other song requests.
     * @principle Enforces role-based access control and owner-based access control.
     */
    match /song_requests/{songRequestId} {
      allow get:   if isOwner() || isAdmin() || (isSignedIn() && resource.data.studentId == request.auth.uid);
      allow list: if isOwner() || isAdmin();
      allow create: if isSignedIn();
      allow update: if isOwner() || isAdmin() || (isSignedIn() && resource.data.studentId == request.auth.uid);
      allow delete: if isOwner() || isAdmin() || (isSignedIn() && resource.data.studentId == request.auth.uid);
    }

    /**
     * @description Manages audit logs.
     * @path /audit_logs/{logId}
     * @allow (read) Owner reads audit logs.
     * @deny (read) Other users read audit logs.
     * @allow (create) Signed-in user creates an audit log.
     * @deny (update) No one can update audit logs.
     * @deny (delete) No one can delete audit logs.
     * @principle Enforces owner-only access control.
     */
    match /audit_logs/{logId} {
      allow get:   if isOwner();
      allow list: if isOwner();
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Prevents any unauthorized access.
     * @path /{document=**}
     * @deny (read) Any read operation on unknown paths.
     * @deny (write) Any write operation on unknown paths.
     * @principle Denies access to any path not explicitly defined.
     */
    match /{document=**} { allow read, write: if false; }
  }
}