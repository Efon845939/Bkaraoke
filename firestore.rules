/**
 * @fileoverview Firestore Security Rules for Song Request App.
 *
 * Core Philosophy:
 * This ruleset prioritizes security by enforcing strict ownership for student profiles
 * and allowing only authenticated users to manage their own song requests.
 *
 * Data Structure:
 * - /students/{studentId}: Stores student profiles, with studentId matching the Firebase Auth UID.
 * - /song_requests/{songRequestId}: Stores all song requests, accessible for reading by all users.
 *   Write access is limited to the student who made the request.
 *
 * Key Security Decisions:
 * - Students can only create, update, and delete their own profiles.
 * - All users can read song requests, but only the request creator can modify or delete them.
 * - Data validation is relaxed in prototyping mode to allow for flexible schema changes.
 *
 * Denormalization for Authorization:
 * The `SongRequest` entity includes a `studentId` field that must match the authenticated user's UID
 * for create, update, and delete operations.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows students to manage their own profile.
     * @path /students/{studentId}
     * @allow (create) User with UID 'gQrXRLPYk2ZWtua8SgYnu5fYhn12' can create a student document where studentId matches their UID.
     * @deny (create) User with UID 'gQrXRLPYk2ZWtua8SgYnu5fYhn12' cannot create a student document where studentId does not match their UID.
     * @allow (get, list) User with UID 'gQrXRLPYk2ZWtua8SgYnu5fYhn12' can get/list their student profile.
     * @allow (update) User with UID 'gQrXRLPYk2ZWtua8SgYnu5fYhn12' can update their student profile.
     * @deny (update) User with UID 'gQrXRLPYk2ZWtua8SgYnu5fYhn12' cannot update someone else's student profile.
     * @allow (delete) User with UID 'gQrXRLPYk2ZWtua8SgYnu5fYhn12' can delete their student profile.
     * @deny (delete) User with UID 'gQrXRLPYk2ZWtua8SgYnu5fYhn12' cannot delete someone else's student profile.
     * @principle Enforces document ownership for writes and restricts access to a user's own data tree.
     */
    match /students/{studentId} {
      allow get: if isSignedIn() && isOwner(studentId);
      allow list: if isSignedIn() && isOwner(studentId);
      allow create: if isSignedIn() && request.auth.uid == studentId;
      allow update: if isSignedIn() && isOwner(studentId);
      allow delete: if isSignedIn() && isOwner(studentId);
    }

    /**
     * @description Allows any user to read song requests, but only the creator can modify or delete them.
     * @path /song_requests/{songRequestId}
     * @allow (get, list) Any user can read song requests.
     * @allow (create) User with UID 'gQrXRLPYk2ZWtua8SgYnu5fYhn12' can create a song request if studentId matches their UID.
     * @deny (create) User with UID 'gQrXRLPYk2ZWtua8SgYnu5fYhn12' cannot create a song request if studentId does not match their UID.
     * @allow (update) User with UID 'gQrXRLPYk2ZWtua8SgYnu5fYhn12' can update a song request they created.
     * @deny (update) User with UID 'gQrXRLPYk2ZWtua8SgYnu5fYhn12' cannot update a song request created by someone else.
     * @allow (delete) User with UID 'gQrXRLPYk2ZWtua8SgYnu5fYhn12' can delete a song request they created.
     * @deny (delete) User with UID 'gQrXRLPYk2ZWtua8SgYnu5fYhn12' cannot delete a song request created by someone else.
     * @principle Public read access with owner-only writes, enforces document ownership for modifications.
     */
    match /song_requests/{songRequestId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.studentId == request.auth.uid;
      allow update: if isSignedIn() && resource.data.studentId == request.auth.uid;
      allow delete: if isSignedIn() && resource.data.studentId == request.auth.uid;
    }

    // Helper functions
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function isExistingOwner(userId) {
        return isSignedIn() && request.auth.uid == userId;
    }

    function isSongRequestOwner(songRequestId) {
        return request.auth.uid == resource.data.studentId;
    }

    function isExistingSongRequestOwner(songRequestId) {
        return isSignedIn() && isSongRequestOwner(songRequestId);
    }
  }
}