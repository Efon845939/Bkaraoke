/**
 * @fileoverview Firestore Security Rules for the Karaoke Request App.
 *
 * Core Philosophy:
 * This ruleset enforces a role-based access control model, with 'student' and 'admin' roles.
 * Students can only read their own profile. Admins have no access to student profiles.
 * All users can create song requests. Only admins can modify or delete them.
 * The audit log is write-only for authenticated users, but not listable or gettable.
 *
 * Data Structure:
 * - /students/{studentId}: Stores student profiles, where {studentId} is the Firebase Auth UID.
 * - /song_requests/{songRequestId}: Stores song requests.
 * - /audit_logs/{logId}: Stores audit logs.
 *
 * Key Security Decisions:
 * - Students collection is not listable. This prevents unauthorized enumeration of user accounts.
 * - Audit logs are write-only. This ensures that logs can be created but not read, preserving their integrity.
 *
 * Denormalization for Authorization:
 *  - Song requests include `studentId` to easily verify the submitter.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Protects the student profiles. Students can only read their own profiles. Admins have no access.
     * @path /databases/{database}/documents/students/{studentId}
     * @allow (get) User with UID 'studentId' is authenticated.
     * @allow (create) User with UID 'studentId' is authenticated and creating their own profile
     * @allow (update) User with UID 'studentId' is authenticated and updating their own profile
     * @allow (delete) User with UID 'studentId' is authenticated and deleting their own profile
     * @deny (get) User with UID other than 'studentId' attempts to read.
     * @deny (list) Any user attempts to list all students.
     * @deny (create) User with UID other than 'studentId' attempts to create.
     * @deny (update) User with UID other than 'studentId' attempts to update.
     * @deny (delete) User with UID other than 'studentId' attempts to delete.
     * @principle Enforces document ownership for writes, restricts access to a user's own data tree.
     */
    match /students/{studentId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(studentId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(studentId) && request.resource.data.id == studentId;
      allow update: if isExistingOwner(studentId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(studentId);
    }

    /**
     * @description Manages song requests. Anyone can create a song request, but only admins can modify or delete them.
     * @path /databases/{database}/documents/song_requests/{songRequestId}
     * @allow (get, list) Any user can retrieve or list all song requests.
     * @allow (create) Any authenticated user can create a song request.
     * @deny (update, delete) Only an admin user can modify or delete song requests.
     * @principle Allows public read access but restricts modifications to authorized users (admins).
     */
    match /song_requests/{songRequestId} {
      function isSignedIn() {
        return request.auth != null;
      }

      // TODO: Implement admin role verification. This is a placeholder.
      function isAdmin() {
          return false;
        //return request.auth.token.role == 'admin'; // Example: Assuming the role is stored in the auth token
      }

      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.studentId == request.auth.uid; // Validate that the request's studentId matches the authenticated user's UID.
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }

    /**
     * @description Manages audit logs. Only authenticated users can create logs. Logs are not readable.
     * @path /databases/{database}/documents/audit_logs/{logId}
     * @allow (create) Any authenticated user can create an audit log.
     * @deny (get, list, update, delete) No one can read, list, update, or delete audit logs.
     * @principle Enforces write-only access for audit logs to maintain integrity and prevent information leakage.
     */
    match /audit_logs/{logId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow get, list: if false;
      allow create: if isSignedIn();
      allow update, delete: if false;
    }
  }
}