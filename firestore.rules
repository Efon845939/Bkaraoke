rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    ///// ORTAK YARDIMCI FONKSİYONLAR /////
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(studentId) {
      return isSignedIn() && request.auth.uid == studentId;
    }

    function isAdmin() {
      return isSignedIn()
        && exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }

    ///// ÖĞRENCİ PROFİLLERİ /////
    // /students/{studentId}
    match /students/{studentId} {
      // Sadece kendi profilini görebilir ve düzenleyebilir.
      allow get, create, update, delete: if isOwner(studentId);

      // Listeleme yasak (tüm öğrencileri çekemesin)
      allow list: if false;
    }

    ///// ADMIN ROLLERİ /////
    // /roles_admin/{adminId}
    match /roles_admin/{adminId} {
      // Admin kendi rol dokümanını görebilir (isteğe göre kapatılabilir)
      allow get: if isAdmin();

      // Listeleme ve değişiklik tamamen kapalı (sadece backend / console ile)
      allow list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    ///// ŞARKI İSTEKLERİ /////
    // /song_requests/{songRequestId}
    match /song_requests/{songRequestId} {

      // Herkes listeyi görebilir (sırayı ekranda göstermek için)
      allow get: if true;
      allow list: if true;

      // Yeni istek: sadece giriş yapmış kullanıcı ve kendi UID’sini studentId olarak yazıyorsa
      allow create: if isSignedIn()
                    && request.resource.data.studentId == request.auth.uid;

      // Güncelleme / silme:
      // - Dokümanın sahibi
      // - VEYA admin
      allow update, delete: if isSignedIn()
                            && (
                              isOwner(resource.data.studentId)
                              || isAdmin()
                            );
    }

    ///// DENETİM LOG KAYITLARI /////
    // /audit_logs/{logId}
    match /audit_logs/{logId} {

      // Log oluşturma: herhangi giriş yapmış kullanıcı (istemci tarafı log basabilir)
      allow create: if isSignedIn();

      // Logları görme / listeleme: SADECE admin
      allow get, list: if isAdmin();

      // Loglar değiştirilemez ve silinemez
      allow update: if false;
      allow delete: if false;
    }
  }
}
