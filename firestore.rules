/**
 * @fileoverview Firestore Security Rules for the Karaoke Request App.
 *
 * Core Philosophy:
 * This ruleset implements a role-based access control (RBAC) model with "student" and "admin" roles.
 * Students can only manage their own profiles and create song requests.
 * Admins can manage all song requests and audit logs.
 *
 * Data Structure:
 * - /students/{studentId}: Stores student profiles, with the document ID matching the Firebase Auth UID.
 * - /song_requests/{songRequestId}: Stores all song requests.
 * - /audit_logs/{logId}: Stores audit logs.
 *
 * Key Security Decisions:
 * - User listing is explicitly denied to protect user privacy.
 * - Read-only collections are not used in this version.
 * - The rules default to strict access control, requiring explicit "allow" statements.
 *
 * Denormalization for Authorization:
 * The `SongRequest` entity denormalizes the `studentName` to avoid needing to fetch student profiles for display purposes.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Secure student profiles. Students can only read/write their own profile.
     * @path /students/{studentId}
     * @allow (create) - A user with UID 'user_abc' can create their own profile at /students/user_abc.
     * @allow (get, update, delete) - A user with UID 'user_abc' can read/update/delete their own profile at /students/user_abc.
     * @deny (create) - A user with UID 'user_abc' cannot create a profile at /students/user_xyz.
     * @deny (get, update, delete) - A user with UID 'user_abc' cannot read/update/delete the profile at /students/user_xyz.
     * @principle Enforces document ownership and validated relational integrity between the path and the document's `id` field.
     */
    match /students/{studentId} {
      function isOwner(studentId) {
        return request.auth.uid == studentId;
      }

      function isAdmin() {
        return get(/databases/$(database)/documents/students/$(request.auth.uid)).data.role == 'admin';
      }

      allow get: if isOwner(studentId);
      allow list: if false;
      allow create: if isOwner(studentId);
      allow update: if isOwner(studentId);
      allow delete: if isOwner(studentId);
    }

    /**
     * @description Secure song requests. Admins can manage all requests. Students can create requests.
     * @path /song_requests/{songRequestId}
     * @allow (create) - A signed-in user can create a song request. The request.resource.data.studentId must match the user's UID.
     * @allow (get, list, update, delete) - An admin can read/list/update/delete any song request.
     * @deny (update, delete) - A non-admin user cannot update or delete any song request.
     * @principle Enforces role-based access control for song requests.
     */
    match /song_requests/{songRequestId} {
       function isSignedIn() {
          return request.auth != null;
        }

       function isStudent() {
            return get(/databases/$(database)/documents/students/$(request.auth.uid)).data.role == 'student';
       }

      function isAdmin() {
            return get(/databases/$(database)/documents/students/$(request.auth.uid)).data.role == 'admin';
      }

      allow get, list: if isAdmin();
      allow create: if isSignedIn();
      allow update, delete: if isAdmin();
    }

    /**
     * @description Secure audit logs. Only admins can read and write audit logs.
     * @path /audit_logs/{logId}
     * @allow (create) - An admin can create an audit log.
     * @allow (get, list) - An admin can read and list audit logs.
     * @deny (create, get, list) - A non-admin user cannot create, read, or list audit logs.
     * @principle Enforces role-based access control for audit logs.
     */
    match /audit_logs/{logId} {

      function isAdmin() {
        return get(/databases/$(database)/documents/students/$(request.auth.uid)).data.role == 'admin';
      }
      allow get, list, create: if isAdmin();
      allow update, delete: if false;
    }
  }
}