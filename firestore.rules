/**
 * @file Firestore Security Rules
 * @description This ruleset enforces a user-ownership model for student profiles and restricts song request access based on user roles (student or admin).
 *
 * Data Structure:
 * - /students/{studentId}: Stores student profiles, where studentId matches the Firebase Auth UID.
 * - /song_requests/{songRequestId}: Stores all song requests in a single collection.
 *
 * Key Security Decisions:
 * - Students can only read their own profile data.
 * - Students can create song requests, but cannot update or delete them.
 * - Only administrators (authenticated with a specific admin pin) can list all song requests.
 * - Data shape validation is relaxed during this prototyping phase, except for the studentId and ownership checks.
 *
 * Denormalization for Authorization:
 * - Song requests contain a denormalized `studentId` field, which is used to restrict access to the student who created the request.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows students to read their own profile data and create their own profile on signup.
     * @path /students/{studentId}
     * @allow (get, list): If the user is signed in and the studentId matches the authenticated user's UID.
     * @allow (create): If the user is signed in and the studentId matches the authenticated user's UID.
     * @deny (update, delete): Students cannot update or delete their profiles.
     * @principle Enforces document ownership for reads and restricts modifications.
     */
    match /students/{studentId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return isSignedIn() && request.auth.uid == userId;
      }

      allow get: if isOwner(studentId);
      allow list: if isOwner(studentId);

      allow create: if isOwner(studentId) && request.resource.data.id == studentId;

      allow update, delete: if false;
    }

    /**
     * @description Allows students to create song requests and allows admins to read all song requests.
     * @path /song_requests/{songRequestId}
     * @allow (create): If the user is signed in and the studentId matches the authenticated user's UID.
     * @allow (get): Always, assuming admins will need to read individual documents.
     * @allow (list): Only if the user is an admin.
     * @deny (update, delete): Students cannot update or delete song requests.
     * @principle Enforces owner-only writes for students and admin-only reads for all requests.
     */
    match /song_requests/{songRequestId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isAdmin() {
        return isSignedIn() && request.auth.token.firebase.sign_in_provider == "password" && request.auth.uid == "admin_kara90ke";
      }

      allow get: if isAdmin();
      allow list: if isAdmin();

      allow create: if isSignedIn() && request.resource.data.studentId == request.auth.uid;
      allow update, delete: if false;
    }
  }
}