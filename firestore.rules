/**
 * @fileoverview Firestore Security Rules for Karaoke App
 *
 * Core Philosophy:
 * This ruleset enforces a role-based access control model.  Students can read song requests, but not list all audit logs.
 * Admins can read and write all song requests. Audit logs are writeable by server/trusted environment only and should not be readable from the client.
 *
 * Data Structure:
 * - /students/{studentId}: Stores student and admin profiles. `studentId` MUST match the Firebase Auth UID.
 * - /song_requests/{songRequestId}: Stores all song requests in a single collection.
 * - /audit_logs/{logId}: Stores audit logs, accessible only to backend services.
 *
 * Key Security Decisions:
 * - Students are only able to list or read song requests.
 * - The 'id' field in the `/students/{studentId}` collection must match the `studentId` path parameter (enforced on create and update).
 * - Audit logs are not readable from the client.  Writes to the audit log should happen from a trusted environment.
 *
 * Denormalization for Authorization:
 * - The `SongRequest` entity denormalizes `studentName` to avoid needing to read the student document to display the student's name in the request list.
 *
 * Structural Segregation:
 * - The application stores private user data (student profiles) and public data (song requests) in separate collections with distinct access controls.
 */

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the user is signed in.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user's UID matches the provided userId.
     * @param {string} userId - The user ID to compare against.
     * @returns {boolean} - True if the user is signed in and the UID matches, false otherwise.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the authenticated user is an existing owner of the document.
     * @param {string} userId - The user ID to compare against the resource.
     * @returns {boolean} - True if the user is signed in, the UID matches, and the document exists.
     */
    function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
    }

    /**
     * @description Determines if the authenticated user has the 'admin' role.
     * @returns {boolean} True if the user's role is 'admin'.
     */
    function isAdmin() {
        return get(/databases/$(database)/documents/students/$(request.auth.uid)).data.role == 'admin';
    }

    /**
     * @description Rules for student documents.
     * @path /students/{studentId}
     * @allow (create) User with UID 'user123' can create their own student document at /students/user123.
     * @deny (create) User with UID 'user123' cannot create a student document for another user at /students/user456.
     * @allow (get) User with UID 'user123' can read their own student document at /students/user123.
     * @deny (get) User with UID 'user123' cannot read another user's student document at /students/user456.
     * @principle Enforces document ownership for reads and writes; validates relational integrity between path and document data.
     */
    match /students/{studentId} {
        allow create: if isOwner(studentId)
                       && request.resource.data.id == studentId;
        allow get: if isOwner(studentId) || isAdmin();
        allow update: if isExistingOwner(studentId)
                        && request.resource.data.id == resource.data.id; //Enforce immutability of the id.
        allow delete: if isExistingOwner(studentId) || isAdmin();
        allow list: if false;
    }

    /**
     * @description Rules for song requests.
     * @path /song_requests/{songRequestId}
     * @allow (create) Admin can create a song request.
     * @deny (create) Non-admin cannot create a song request.
     * @allow (get) Anyone can get a song request.
     * @allow (list) Anyone can list song requests.
     * @allow (update) Admin can update any song request.
     * @deny (update) Non-admin cannot update any song request.
     * @allow (delete) Admin can delete any song request.
     * @deny (delete) Non-admin cannot delete any song request.
     */
    match /song_requests/{songRequestId} {
        allow create: if isAdmin();
        allow get: if true;
        allow list: if true;
        allow update: if isAdmin();
        allow delete: if isAdmin();
    }

    /**
     * @description Rules for audit logs.
     * @path /audit_logs/{logId}
     * @deny (create) Client cannot create audit logs.
     * @deny (get) Client cannot get audit logs.
     * @deny (list) Client cannot list audit logs.
     * @deny (update) Client cannot update audit logs.
     * @deny (delete) Client cannot delete audit logs.
     * @principle Restricts all client access to audit logs.
     */
    match /audit_logs/{logId} {
        allow create: if false;
        allow get: if false;
        allow list: if false; // Fixed: Denied list permission here, which was causing the error.
        allow update: if false;
        allow delete: if false;
    }
  }
}