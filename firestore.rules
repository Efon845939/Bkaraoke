/**
 * @fileoverview Firestore Security Rules for the Karaoke App.
 *
 * Core Philosophy:
 * This ruleset enforces a role-based access control model. Students can only manage their own profiles.
 * Admins have broad access to manage song requests and audit logs.
 *
 * Data Structure:
 * - /students/{studentId}: Stores student and admin user profiles. The `studentId` matches the Firebase Auth UID.
 * - /song_requests/{songRequestId}: Stores all song requests.
 * - /audit_logs/{logId}: Stores audit logs of actions performed in the application.
 *
 * Key Security Decisions:
 * - Students can only create their own profiles and read/update their own data.
 * - Students cannot list all student profiles.
 * - Admins can create, read, update, and delete any song request.
 * - Audit logs can only be created by the server. No client writes are permitted.
 *
 * Denormalization for Authorization:
 *  - The `SongRequest` includes the `studentId` to easily verify which student submitted the request.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Manages student profiles.
     * @path /students/{studentId}
     * @allow (create) - A user can create their own profile if the studentId matches their auth UID.
     * @allow (get, update) - A user can get and update their own profile if the studentId matches their auth UID.
     * @deny (create) - A user cannot create a profile for another user (studentId does not match auth UID).
     * @deny (list, delete) - Users cannot list all profiles or delete their profile.
     * @principle Enforces document ownership for user profiles.
     */
    match /students/{studentId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      // Only allow creation if the studentId matches the authenticated user's UID.
      allow create: if isOwner(studentId)
                   && request.resource.data.id == studentId;

      // Only allow reading if the studentId matches the authenticated user's UID.
      allow get: if isOwner(studentId);

      // Students can only update their own profiles
      allow update: if isExistingOwner(studentId)
                    && request.resource.data.id == studentId;

      // No one can delete a profile via the rules (can be done via backend).
      allow delete: if false;

      // Students can not list all users
      allow list: if false;
    }

    /**
     * @description Manages song requests. Admins can manage all requests, while students have no direct access.
     * @path /song_requests/{songRequestId}
     * @allow (get, list) - Anyone can read song requests.
     * @allow (create, update, delete) - Only admins can create, update, or delete song requests.
     * @deny (create, update, delete) - Students cannot create, update, or delete song requests.
     * @principle Enforces role-based access control for song request management.
     */
    match /song_requests/{songRequestId} {
        function isAdmin() {
            return get(/databases/$(database)/documents/students/$(request.auth.uid)).data.role == 'admin';
        }

        // Anyone can read song requests.
        allow get, list: if true;

        // Only admins can create, update, and delete song requests.
        allow create: if isAdmin();
        allow update: if isAdmin() && resource != null;
        allow delete: if isAdmin() && resource != null;
    }

    /**
     * @description Manages audit logs. Only the server can create audit logs. Clients cannot read, write, or list audit logs.
     * @path /audit_logs/{logId}
     * @allow (create) - Only the server can create audit logs.
     * @deny (get, list, update, delete) - Clients cannot read, write, or list audit logs.
     * @principle Restricts access to audit logs for security and data integrity.
     */
    match /audit_logs/{logId} {
        // Only allow the server to create audit logs. In a real application,
        // this would be achieved using a service account or similar mechanism.
        // For prototyping, we simply deny all client-side writes.
        allow create: if false;

        // No one can read, update, or delete audit logs via the rules.
        allow get, list, update, delete: if false;
    }
  }
}