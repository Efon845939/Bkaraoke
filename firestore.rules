/**
 * @file Firestore Security Rules
 * @description This ruleset enforces role-based access control for a karaoke application.
 *
 * Data Structure:
 * - /students/{studentId}: Stores student and admin profiles. The 'studentId' MUST match the Firebase Auth UID.
 * - /song_requests/{songRequestId}: Stores song requests. Each request contains a denormalized 'studentId' to link back to the user.
 * - /audit_logs/{logId}: Stores a chronological log of actions.
 *
 * Key Security Decisions:
 * - Access to student profiles is limited to the owner (the student themselves) and admins.
 * - Song requests can be read/written by owners, admins, and the student who created the request.
 * - Audit logs are readable only by owners.
 *
 * Denormalization for Authorization:
 * - The `song_requests` collection denormalizes the `studentId` into each document to allow rules to quickly verify ownership without additional reads.
 *
 * Email-Based Roles:
 *  - Owner: efe.küçükvardar@karaoke.owner.app
 *  - Admin: *@karaoke.admin.app
 *  - Student: *@karaoke.app
 */
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() { return request.auth != null; }
    function hasEmail()   { return isSignedIn() && request.auth.token.email != null; }

    // Case-insensitive domain kontrolü (RE2)
    function isOwner() {
      return hasEmail() && request.auth.token.email.matches('(?i)[^@]+@karaoke\\.owner\\.app$');
    }
    function isAdmin() {
      return hasEmail() && request.auth.token.email.matches('(?i)[^@]+@karaoke\\.admin\\.app$');
    }
    function isStudent() {
      return hasEmail() && request.auth.token.email.matches('(?i)[^@]+@karaoke\\.app$');
    }

    function isOwnerOfDoc(studentId) {
      return isSignedIn() && studentId == request.auth.uid;
    }

    /**
     * @description Controls access to student profiles.
     * @path /students/{studentId}
     * @allow (read) User with email efe.küçükvardar@karaoke.owner.app can read any student profile.
     * @allow (read) User with email test@karaoke.app can read their own profile (if studentId matches).
     * @deny (read) User with email test@karaoke.app cannot read another user's profile.
     * @allow (create) User with any email can create a student profile.
     * @allow (update) User with email efe.küçükvardar@karaoke.owner.app can update any student profile.
     * @allow (update) User with email test@karaoke.app can update their own profile (if studentId matches).
     * @deny (delete) No one can delete a student profile.
     * @principle Enforces role-based access and user ownership for student profiles.
     */
    match /students/{studentId} {
      // Owner veya Admin tümünü okuyabilir. Kullanıcı kendi belgesini okuyabilir/güncelleyebilir.
      allow get:   if isOwner() || isAdmin() || (isSignedIn() && request.auth.uid == studentId);
      allow list: if false; // List operations disabled for security.
      allow create: if isSignedIn() && request.auth.uid == studentId;
      allow update: if isOwner() || isAdmin() || (isSignedIn() && request.auth.uid == studentId);
      allow delete: if false;
    }

    /**
     * @description Controls access to song requests.
     * @path /song_requests/{songRequestId}
     * @allow (read) User with email efe.küçükvardar@karaoke.owner.app can read any song request.
     * @allow (read) User with email test@karaoke.app can read song requests where studentId matches.
     * @deny (read) User with email test@karaoke.app cannot read another user's song requests.
     * @allow (create) User with any email can create a song request.
     * @allow (update) User with email efe.küçükvardar@karaoke.owner.app can update any song request.
     * @allow (update) User with email test@karaoke.app can update song requests where studentId matches.
     * @allow (delete) User with email efe.küçükvardar@karaoke.owner.app can delete any song request.
     * @allow (delete) User with email test@karaoke.app can delete song requests where studentId matches.
     * @principle Enforces role-based access and user ownership for song requests.
     */
    match /song_requests/{songRequestId} {
      allow get:   if isOwner() || isAdmin() || (isSignedIn() && getStudentId() == request.auth.uid);
      allow list: if false; // List operations disabled for security.
      allow create: if isSignedIn();
      allow update: if isOwner() || isAdmin() || (isSignedIn() && getStudentId() == request.auth.uid);
      allow delete: if isOwner() || isAdmin() || (isSignedIn() && getStudentId() == request.auth.uid);

      function getStudentId() {
        return resource.data.studentId;
      }
    }

    /**
     * @description Controls access to audit logs.
     * @path /audit_logs/{logId}
     * @allow (read) User with email efe.küçükvardar@karaoke.owner.app can read any audit log.
     * @deny (read) User with email test@karaoke.app cannot read audit logs.
     * @allow (create) User with any email can create an audit log.
     * @deny (update) No one can update an audit log.
     * @deny (delete) No one can delete an audit log.
     * @principle Restricts audit log access to owner only.
     */
    match /audit_logs/{logId} {
      allow get:   if isOwner();
      allow list: if false; // List operations disabled for security.
      allow create: if isOwner();
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Catches all other documents and prevents any access.
     * @path /{document=**}
     * @deny (read) Any read operation on unmatched paths.
     * @deny (write) Any write operation on unmatched paths.
     * @principle Default deny rule to ensure no accidental open access.
     */
    match /{document=**} {
       allow read, write: if false;
    }
  }
}