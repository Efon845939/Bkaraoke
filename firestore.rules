rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Manages student profiles. Students can read their own profile; admins can read any.
     * @path /databases/{database}/documents/students/{studentId}
     * @allow (get) User with UID 'studentId' requests their own profile.
     * @allow (get) Admin user requests any student profile.
     * @deny (get) Student user requests another student's profile.
     * @allow (list) Admin user requests all student profiles.
     * @deny (list) Student user requests all student profiles.
     * @allow (create) User creates their own profile with matching UID.
     * @allow (update) User updates their own profile.
     * @allow (delete) User deletes their own profile.
     * @deny (create) User creates a profile with a mismatched UID.
     * @deny (update) User attempts to modify another user's profile.
     * @deny (delete) User attempts to delete another user's profile.
     * @principle Enforces document ownership and role-based access control.
     */
    match /students/{studentId} {
      // Helpers
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(studentId) {
        return request.auth.uid == studentId;
      }

        allow get: if isSignedIn() && (isOwner(studentId) || isAdmin());
        // The error report shows that the user is attempting to list all students.
        // This is not allowed for regular students.
        allow list: if isSignedIn() && isAdmin();
        allow create: if isSignedIn() && isOwner(studentId);
        allow update: if isSignedIn() && isOwner(studentId);
        allow delete: if isSignedIn() && isOwner(studentId);

        function isAdmin() {
            return get(/databases/$(database)/documents/admins/$(request.auth.uid)).data.isAdmin == true;
        }


    }

        match /admins/{adminId}{
            allow read, write: if false;
    }

    /**
     * @description Manages song requests. Publicly readable, but only admins can create, update, or delete.
     * @path /databases/{database}/documents/song_requests/{songRequestId}
     * @allow (get) Any user can read any song request.
     * @allow (list) Any user can list all song requests.
     * @allow (create) Admin user creates a song request.
     * @allow (update) Admin user updates a song request.
     * @allow (delete) Admin user deletes a song request.
     * @deny (create) Non-admin user attempts to create a song request.
     * @deny (update) Non-admin user attempts to modify a song request.
     * @deny (delete) Non-admin user attempts to delete a song request.
     * @principle Enforces public read access with admin-only write access.
     */
    match /song_requests/{songRequestId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isAdmin() {
            return get(/databases/$(database)/documents/admins/$(request.auth.uid)).data.isAdmin == true;
      }
      allow get, list: if true;
      allow create: if isSignedIn() && isAdmin();
      allow update: if isSignedIn() && isAdmin();
      allow delete: if isSignedIn() && isAdmin();

    }

    /**
     * @description Manages audit logs. Only the server can write audit logs; they are never readable by clients.
     * @path /databases/{database}/documents/audit_logs/{logId}
     * @allow (create) Server creates an audit log entry.
     * @deny (get) Any user attempts to read an audit log.
     * @deny (list) Any user attempts to list audit logs.
     * @deny (update) Any user attempts to update an audit log.
     * @deny (delete) Any user attempts to delete an audit log.
     * @principle Enforces server-only write access for audit logs.
     */
    match /audit_logs/{logId} {
      allow create: if request.auth.uid == 'server'; // TODO: Add server-side authentication for writing logs
      allow get: if false;
      allow list: if false;
      allow update: if false;
      allow delete: if false;

    }
  }
}