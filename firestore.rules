/**
 * @fileoverview Firestore Security Rules for the Karaoke App.
 *
 * Core Philosophy:
 * This ruleset enforces a role-based access control model, with "owner," "admin," and "participant" roles.
 * Participants can only manage their own data, while owners and admins have broader access.  Data consistency is enforced
 * by validating key ownership fields on create and enforcing immutability on update.
 *
 * Data Structure:
 * - /students/{participantId}: Stores participant profiles. `participantId` matches the Firebase Auth UID.
 * - /song_requests/{songRequestId}: Stores song requests.  Each request has a `studentId` field linking it to the user who created it.
 * - /audit_logs/{logId}: Stores audit logs.  Only accessible to owners.
 *
 * Key Security Decisions:
 * - Participants can only view, create, update, and delete their own song requests and profile data.
 * - Owners and admins can read all data, but only owners can access audit logs.
 * - Listing all participants is disallowed for regular participants; only owners/admins can list all profiles.
 *
 * Denormalization for Authorization:
 * - Song requests include a `studentId` field to easily enforce ownership without additional lookups.
 *
 * Structural Segregation:
 * - All song requests are in a single top-level collection. The `studentId` field indicates ownership.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions to determine user roles based on email domain.
    function isSignedIn() {
      return request.auth != null;
    }

    function hasEmail() {
      return isSignedIn() && request.auth.token.email != null;
    }

    function isOwner() {
      return hasEmail() && request.auth.token.email.matches(".*@karaoke\\.owner\\.app$");
    }

    function isAdmin() {
      return hasEmail() && request.auth.token.email.matches(".*@karaoke\\.admin\\.app$");
    }

    function isParticipant() {
      return hasEmail() && request.auth.token.email.matches(".*@karaoke\\.app$");
    }

    // Helper function to determine if the current user is the owner of a document, based on the `studentId` field.
    function isOwnerOfDocument(studentId) {
      return isSignedIn() && request.auth.uid == studentId;
    }

    function isExistingOwner(studentId) {
        return isOwnerOfDocument(studentId) && resource != null;
    }

    /**
     * @description Manages access to participant profiles.
     * @path /students/{participantId}
     * @allow (read) Owner/Admin can read all profiles. Participant can read their own profile.
     * @deny (read) Participant tries to read another participant's profile.
     * @allow (create) Any signed-in user can create their profile.
     * @allow (update) Owner can update any profile. Participant can update their own profile.
     * @allow (delete) Owner can delete any profile. Participant can delete their own profile.
     * @principle Enforces document ownership for profiles, with elevated privileges for owner and admin roles.
     */
    match /students/{participantId} {
      allow get:    if isOwner() || isAdmin() || (isSignedIn() && request.auth.uid == participantId);
      allow list:   if isOwner() || isAdmin();
      allow create: if isSignedIn() && request.auth.uid == participantId;
      allow update: if isOwner() || (isSignedIn() && request.auth.uid == participantId);
      allow delete: if isOwner() || (isSignedIn() && request.auth.uid == participantId);
    }

    /**
     * @description Manages access to song requests.
     * @path /song_requests/{songRequestId}
     * @allow (read) Owner/Admin can read all requests. Participant can read their own requests.
     * @deny (read) Participant tries to read another participant's request.
     * @allow (create) Any signed-in user can create a song request.
     * @allow (update) Owner can update any request. Participant can update their own requests.
     * @allow (delete) Owner can delete any request. Participant can delete their own requests.
     * @principle Enforces document ownership for song requests, with elevated privileges for owner and admin roles.
     */
    match /song_requests/{songRequestId} {
      allow get:    if isOwner() || isAdmin() || (isSignedIn() && resource.data.studentId == request.auth.uid);
      allow list:   if isOwner() || isAdmin();
      allow create: if isSignedIn() && request.resource.data.studentId == request.auth.uid;
      allow update: if isOwner() || (isSignedIn() && request.resource.data.studentId == request.auth.uid);
      allow delete: if isOwner() || (isSignedIn() && resource.data.studentId == request.auth.uid);
    }

    /**
     * @description Manages access to audit logs.
     * @path /audit_logs/{logId}
     * @allow (read) Owner can read all logs.
     * @deny (read) Non-owner tries to read logs.
     * @allow (create) Any signed-in user can create a log entry.
     * @deny (update) No one can update a log entry.
     * @deny (delete) No one can delete a log entry.
     * @principle Restricts access to audit logs to the owner role.
     */
    match /audit_logs/{logId} {
      allow get:    if isOwner();
      allow list:   if isOwner();
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if false;
    }
  }
}