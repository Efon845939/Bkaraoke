/**
 * @fileoverview Firestore Security Rules for the Karaoke App.
 *
 * Core Philosophy:
 * This ruleset prioritizes secure access control based on user roles (student, admin) and data ownership.
 * It enforces strict access control for write operations while allowing flexible read permissions where appropriate.
 *
 * Data Structure:
 * - /students/{studentId}: Stores user profiles, with 'studentId' matching the Firebase Auth UID.
 * - /song_requests/{songRequestId}: Stores all song requests in a flat collection.
 * - /audit_logs/{logId}: Stores audit logs of actions performed in the system.
 *
 * Key Security Decisions:
 * - Students can only read and modify their own profile data.
 * - Only authenticated users can create song requests.
 * - Public read access is granted for song requests.
 * - Audit logs are only writeable, not readable via the API.
 *
 * Denormalization for Authorization:
 * - The `SongRequest` entity denormalizes the `studentName` to avoid requiring a lookup to the `students` collection during display.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Manages student profiles.
     * @path /students/{studentId}
     * @allow (create) Authenticated user can create their own profile.
     * @allow (get, list, update) Owner can read and update their own profile.
     * @deny (create, update, delete) Non-owners cannot modify student profiles.
     * @principle Enforces document ownership.
     */
    match /students/{studentId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function isOwner(studentId) {
        return request.auth != null && request.auth.uid == studentId;
      }
      function isExistingOwner(studentId) {
        return isOwner(studentId) && resource != null;
      }

      // Allow user to create their own profile if the ID matches their auth UID
      allow create: if isSignedIn() && request.auth.uid == studentId;

      // Allow the owner to read their own profile
      allow get: if isOwner(studentId);
      allow list: if isOwner(studentId);

      // Allow the owner to update their own profile
      allow update: if isExistingOwner(studentId);

      // Prevent anyone from deleting a profile
      allow delete: if false;
    }

    /**
     * @description Manages song requests. Publicly readable, owner-writeable.
     * @path /song_requests/{songRequestId}
     * @allow (get, list) Anyone can read song requests.
     * @allow (create) Authenticated user can create a song request, referencing their studentId.
     * @allow (update, delete) Only the student who created the request can update or delete it.
     * @principle Allows public read access, enforces owner-only writes, validates relational integrity.
     */
    match /song_requests/{songRequestId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function isOwner() {
        return request.auth != null && resource.data.studentId == request.auth.uid;
      }
      function isExistingOwner() {
        return isOwner() && resource != null;
      }

      // Allow anyone to read song requests
      allow get: if true;
      allow list: if true;

      // Allow an authenticated user to create a song request, matching their student ID
      allow create: if isSignedIn() && request.resource.data.studentId == request.auth.uid;

      // Only the owner can update or delete
      allow update: if isExistingOwner();
      allow delete: if isExistingOwner();
    }

    /**
     * @description Manages audit logs.  Write-only.
     * @path /audit_logs/{logId}
     * @allow (create) Any authenticated user can create an audit log entry.
     * @deny (get, list, update, delete) No one can read, update, or delete audit logs.
     * @principle Restricts access to write-only.
     */
    match /audit_logs/{logId} {
        function isSignedIn() {
            return request.auth != null;
        }
        allow create: if isSignedIn();
        allow get: if false;
        allow list: if false;
        allow update: if false;
        allow delete: if false;
    }

    // Block any other reads/writes
    match /{document=**} {
      allow read, write: if false;
    }
  }
}