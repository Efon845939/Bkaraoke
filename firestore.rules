/**
 * @fileoverview Firestore Security Rules for Karaoke App
 *
 * Core Philosophy:
 * This ruleset prioritizes security by enforcing strict user-ownership for student profiles
 * and restricting song request management to authenticated users. It avoids complex authorization
 * logic and data validation in favor of a simple, easily auditable model suitable for rapid prototyping.
 *
 * Data Structure:
 * - /students/{studentId}: Stores individual student profiles, accessible only by the student themselves.
 * - /song_requests/{songRequestId}: Stores all song requests. Updates to the status are restricted to authenticated users.
 *
 * Key Security Decisions:
 * - Students can only read/write their own profiles.
 * - Any authenicated user can update the status of the song request.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Secure student profiles, accessible only by the student themselves.
     * @path /databases/{database}/documents/students/{studentId}
     * @allow (create) - A student can create their profile if the studentId matches their auth UID.
     * @allow (get, list, update, delete) - A student can only access their own profile.
     * @deny (create) - A student cannot create a profile with an ID that doesn't match their auth UID.
     * @principle Enforces document ownership for student profiles.
     */
    match /students/{studentId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(studentId) {
        return request.auth.uid == studentId;
      }

      function isExistingOwner(studentId) {
          return isOwner(studentId) && exists(resource);
      }

      allow get: if isOwner(studentId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(studentId);
      allow update: if isExistingOwner(studentId);
      allow delete: if isExistingOwner(studentId);
    }

    /**
     * @description Secure song requests, allowing any authenticated user to update the status.
     * @path /databases/{database}/documents/song_requests/{songRequestId}
     * @allow (get, list) - Any authenticated user can read all song requests.
     * @allow (update) - Only authenticated user can update any song request.
     * @deny (create, delete) - Song requests cannot be created or deleted directly via the rules.
     * @principle Allows read access for everyone, and only authenticated users can update a request.
     */
    match /song_requests/{songRequestId} {
      function isSignedIn() {
        return request.auth != null;
      }
        allow get, list: if isSignedIn();
        allow create: if false;
        allow update: if isSignedIn();
        allow delete: if false;
    }
  }
}