rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Grants access to student profiles based on role and ownership.
     * @path /students/{studentId}
     * @allow (get) Authenticated admin can read any student profile. Authenticated student can read their own profile.
     * @allow (create) Authenticated user can create their own profile if the ID matches their auth UID.
     * @allow (update) Authenticated user can update their own profile if the ID matches their auth UID.
     * @allow (delete) Authenticated user can delete their own profile if the ID matches their auth UID.
     * @deny (get) Authenticated student cannot read other student profiles.
     * @deny (list) Students cannot list all profiles.
     * @deny (create) Unauthorized user can not create a profile.
     * @deny (update) Unauthorized user can not update a profile.
     * @deny (delete) Unauthorized user can not delete a profile.
     * @principle Enforces document ownership for student profiles and admin read access.
     */
    match /students/{studentId} {
      // Helper function to check if the user is the owner of the student profile.
      function isOwner(studentId) {
        return request.auth != null && request.auth.uid == studentId;
      }

      // Helper function to check if the user is an admin.
      function isAdmin() {
        return request.auth != null && get(/databases/$(database)/documents/admins/$(request.auth.uid)).data.role == 'admin';
      }

      // Allow read access to admins and the owner of the profile.
      allow get: if isOwner(studentId) || isAdmin();
      // Disallow listing the collection
      allow list: if isAdmin();

      // Allow creating a profile if the user is authenticated and the ID matches their auth UID.
      allow create: if request.auth != null && request.auth.uid == studentId;

      // Allow updating a profile if the user is authenticated and the ID matches their auth UID and ID is immutable.
      allow update: if isOwner(studentId);

      // Allow deleting a profile if the user is authenticated and the ID matches their auth UID.
      allow delete: if isOwner(studentId);
    }

    /**
     * @description Grants public read access to song requests and restricts write access to validated owners.
     * @path /song_requests/{songRequestId}
     * @allow (get) Anyone can read song requests.
     * @allow (list) Anyone can list song requests.
     * @allow (create) Authenticated user can create a song request with a matching studentId.
     * @allow (update) Authenticated owner can update their song request.
     * @allow (delete) Authenticated owner can delete their song request.
     * @deny (create) Unauthorized user can not create a song request.
     * @deny (update) Unauthorized user can not update a song request.
     * @deny (delete) Unauthorized user can not delete a song request.
     * @principle Allows public reads for song requests and enforces ownership for writes.
     */
    match /song_requests/{songRequestId} {

      // Allow public read access.
      allow get, list: if true;

      // Allow create if the user is authenticated and the studentId matches their auth UID.
      allow create: if request.auth != null && request.resource.data.studentId == request.auth.uid;

      // Allow update if the user is the existing owner of the song request.
      allow update: if request.auth != null && resource.data.studentId == request.auth.uid;

      // Allow delete if the user is the existing owner of the song request.
      allow delete: if request.auth != null && resource.data.studentId == request.auth.uid;
    }

     /**
      * @description Allows only authenticated users to create audit logs.
      * @path /audit_logs/{logId}
      * @allow (create) Authenticated user can create an audit log.
      * @deny (get) Unauthorized user can not get an audit log.
      * @deny (list) Unauthorized user can not list audit logs.
      * @deny (update) Unauthorized user can not update an audit log.
      * @deny (delete) Unauthorized user can not delete an audit log.
      * @principle Restricts audit log creation to authenticated users.
      */
    match /audit_logs/{logId} {
      // Allow create if the user is authenticated.
      allow create: if request.auth != null;
            allow get, list: if false;

      allow update, delete: if false;
    }
  }

  // Helper function to check if a user is signed in.
  function isSignedIn() {
    return request.auth != null;
  }
}